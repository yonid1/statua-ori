<!DOCTYPE html>
<html lang="he">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>סטטוס שבת בוואטסאפ</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Assistant&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Assistant", sans-serif;
        direction: rtl;
        text-align: center;
        margin: 0;
        padding: 0;
        background-color: #5d3737;
      }
      .status-container {
        width: 420px;
        height: 750px;
        background-image: url('extracted_background.jpg');
        background-size: 130%;
        background-position: center;
        background-repeat: no-repeat;
        background-color: #f5e4d7;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        margin: 20px auto;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        overflow: hidden;
      }
      .arc-text svg {
        width: 300px;
        height: 120px;
      }
      .profile-picture {
        width: 160px;
        height: 260px;
        border-radius: 10px;
        object-fit: cover;
        border: 2px solid #ccc;
        margin-bottom: 10px;
        transform: translateX(-30px) translateY(-10px);
      }
      .title {
        font-size: 22px;
        font-weight: 700;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      .subtitle {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 10px;
        background-color: rgba(255, 255, 255, 0.7);
        padding: 8px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        text-align: center;
      }
      .header-info {
        display: flex;
        justify-content: space-between;
        width: 340px;
        font-size: 18px;
        font-weight: 900;
        margin-bottom: 15px;
        position: relative;
        z-index: 5;
        background-color: rgba(255, 255, 255, 0.7);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      
      .arc-text {
        position: absolute;
        top: 150px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 15;
        pointer-events: none;
        background-color: transparent;
        padding: 0px;
        border-radius: 0px;
        box-shadow: none;
      }
      .shabbat-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 330px;
        margin-bottom: 10px;
      }
      .shabbat-table th,
      .shabbat-table td {
        border: 1px solid #ccc;
        padding: 10px;
        font-size: 16px;
        font-weight: 900;
        text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        text-align: center;
        background-color: rgba(255, 255, 255, 0.7);
      }
      .shabbat-table th {
        background-color: rgba(255, 255, 255, 0.8);
        font-weight: 900;
      }
      .download-btn {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        position: relative;
        z-index: 100;
      }
      .download-btn:hover {
        background-color: #0056b3;
      }
      .footer-text {
        font-size: 30px;
        font-weight: bold;
        font-family: "Assistant", sans-serif;
        color: #000000;
        text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        padding: 15px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 10px;
        display: inline-block;
        text-align: center;
        letter-spacing: 4px;
        margin-top: 10px;
        margin-bottom: 20px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
      }
      #person-overlay {
        position: absolute !important;
        top: 190px !important;
        left: 35% !important;
        transform: translateX(-20%) !important;
        width: 195px !important;
        height: auto !important;
        z-index: 10 !important;
        pointer-events: none !important;
      }
      
      @media (max-width: 768px) {
        #person-overlay {
          left: 10% !important;
          width: 220px !important;
          top: 200px !important;
        }
      }
      
      @media (max-width: 480px) {
        #person-overlay {
          left: 8% !important;
          width: 200px !important;
          top: 180px !important;
        }
      }
      
      @media (min-width: 1200px) {
        #person-overlay {
          left: 25% !important;
          width: 220px !important;
          top: 180px !important;
        }
      }
      
      @media (min-width: 1600px) {
        #person-overlay {
          left: 20% !important;
          width: 250px !important;
          top: 170px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="status-container" id="status">
      <div class="header-info">
        <span id="hebrew-date">תאריך עברי...</span>
        <span id="torah-portion">פרשת שבוע...</span>
      </div>
      <div class="title"></div>
      <div class="subtitle">לעילוי נשמת אורי דנינו בן עינב ה' יקום דמו</div>

      <div class="arc-text">
        <svg width="300" height="120" viewBox="0 0 300 120">
          <path
            id="arc"
            fill="transparent"
            d="M 30 100 A 150 150 0 0 1 270 100"
          />
          <text
            id="arc-text"
            fill="#000"
            font-size="22"
            font-family="Assistant, Arial, sans-serif"
            text-anchor="middle"
            dominant-baseline="middle"
          >
            <textPath href="#arc" startOffset="50%">
              "ראו באורי שזורח"
            </textPath>
          </text>
        </svg>
      </div>
      
      <script>
        function isIOS() {
          return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
      
        window.onload = function () {
          const textElement = document.querySelector("#arc-text textPath");
          if (isIOS()) {
            const originalText = textElement.textContent;
            textElement.textContent = originalText.split("").reverse().join("");
            textElement.setAttribute("direction", "rtl");
          } else {
            textElement.setAttribute("direction", "ltr");
          }
        };
      </script>

      <input
        type="file"
        id="upload"
        accept="image/*"
        style="display: none"
        onchange="loadImage(event)"
      />

      <table class="shabbat-table">
        <thead>
          <tr>
            <th>עיר</th>
            <th>כניסת שבת</th>
            <th>יציאת שבת</th>
            <th>רבינו תם</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ירושלים</td>
            <td id="jerusalem-shabbat-enter">...</td>
            <td id="jerusalem-shabbat-exit">...</td>
            <td id="jerusalem-rabenu-tam">...</td>
          </tr>
          <tr>
            <td>חיפה</td>
            <td id="haifa-shabbat-enter">...</td>
            <td id="haifa-shabbat-exit">...</td>
            <td id="haifa-rabenu-tam">...</td>
          </tr>
          <tr>
            <td>תל אביב</td>
            <td id="tel-aviv-shabbat-enter">...</td>
            <td id="tel-aviv-shabbat-exit">...</td>
            <td id="tel-aviv-rabenu-tam">...</td>
          </tr>
          <tr>
            <td>באר שבע</td>
            <td id="beer-sheva-shabbat-enter">...</td>
            <td id="beer-sheva-shabbat-exit">...</td>
            <td id="beer-sheva-rabenu-tam">...</td>
          </tr>
        </tbody>
      </table>
      <div class="footer-text">שבת שלום ומבורך</div>
    </div>

    <div style="display: flex; gap: 10px; justify-content: center; margin: 20px; flex-wrap: wrap;">
      <button class="download-btn" onclick="downloadImage()">הורד תמונה</button>
      <button class="download-btn" onclick="loadPreviousEvent()" style="background-color: #6c757d;">הקודם</button>
      <button class="download-btn" onclick="loadNextEvent()" style="background-color: #28a745;">הבא</button>
    </div>

    <script id="shabbat-data" type="application/json">
      {}
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/0.1.0/dom-to-image.min.js"></script>
    <script>
      let allEventsData = [];
      let currentEventIndex = 0;
      let eventsByDate = {};

 async function loadShabbatTimes() {
  try {
    allEventsData = await fetch('times/merged_all_cities.json').then(r => r.json());
    
    if (!allEventsData || allEventsData.length === 0) {
      return;
    }

    const today = new Date();
    const todayString = today.toISOString().split("T")[0];

    const upcomingEvents = allEventsData.filter((entry) => entry.entryDate >= todayString);
    if (upcomingEvents.length === 0) {
      return;
    }

    eventsByDate = {};
    upcomingEvents.forEach(entry => {
      if (!eventsByDate[entry.entryDate]) {
        eventsByDate[entry.entryDate] = [];
      }
      eventsByDate[entry.entryDate].push(entry);
    });

    const sortedDates = Object.keys(eventsByDate).sort();
    const closestDate = sortedDates[currentEventIndex] || sortedDates[0];
    const closestEvents = eventsByDate[closestDate];
    
    const hebrewDateElement = document.getElementById("hebrew-date");
    const torahPortionElement = document.getElementById("torah-portion");

    const otherCityEvents = closestEvents.filter(entry => entry.city !== "ירושלים");
    
    let hebrewDate = "תאריך עברי לא זמין";
    let torahPortion = "פרשת שבוע לא זמינה";
    
    if (otherCityEvents.length > 0) {
      const otherCityData = otherCityEvents[0];
      hebrewDate = otherCityData.hebrewDate || hebrewDate;
      torahPortion = otherCityData.torahPortion || torahPortion;
    }

    if (hebrewDateElement) {
      hebrewDateElement.textContent = hebrewDate || "תאריך עברי לא זמין";
    }

    if (torahPortionElement) {
      torahPortionElement.textContent = torahPortion || "פרשת שבוע לא זמינה";
    }

    const cities = [
      { id: "jerusalem", name: "ירושלים" },
      { id: "haifa", name: "חיפה" },
      { id: "tel-aviv", name: "תל אביב" },
      { id: "beer-sheva", name: "באר שבע" },
    ];

    const isHoliday = torahPortion && (
      torahPortion.includes("ראש השנה") || 
      torahPortion.includes("יום כיפור") || 
      torahPortion.includes("סוכות") || 
      torahPortion.includes("פסח") || 
      torahPortion.includes("שבועות") ||
      torahPortion.includes("שמחת תורה") ||
      torahPortion.includes("חג")
    );

    const titleElement = document.querySelector('.title');
    if (titleElement) {
      titleElement.textContent = "";
    }

          const tableHeaders = document.querySelectorAll('.shabbat-table th');
          if (tableHeaders.length >= 3) {
            if (isHoliday) {
              tableHeaders[1].textContent = "כניסת החג";
              tableHeaders[2].textContent = "יציאת החג";
            } else {
              tableHeaders[1].textContent = "כניסת שבת";
              tableHeaders[2].textContent = "יציאת שבת";
            }
          }

    const footerElement = document.querySelector('.footer-text');
    if (footerElement) {
            let footerText = "שבת שלום ומבורך";
      
      if (torahPortion) {
        if (torahPortion.includes("ראש השנה")) {
          footerText = "כתיבה וחתימה טובה";
        } else if (torahPortion.includes("יום כיפור")) {
          footerText = "גמר חתימה טובה";
        } else if (torahPortion.includes("סוכות")) {
          footerText = "חג שמח";
        } else if (torahPortion.includes("שמחת תורה")) {
          footerText = "חג שמח";
        } else if (torahPortion.includes("פסח")) {
          footerText = "פסח כשר ושמח";
        } else if (torahPortion.includes("שבועות")) {
          footerText = "חג שמח";
        }
      }
      
      footerElement.textContent = footerText;
    }
    
    const statusContainer = document.querySelector('.status-container');
    
    if (statusContainer) {
      const isRoshHashana = (torahPortion && torahPortion.includes("ראש השנה")) || 
                                 window.location.search.includes("rosh_hashana");
            
            const isYomKippur = (torahPortion && torahPortion.includes("יום כיפור")) ||
                               window.location.search.includes("yom_kippur");
            
            const isSukot = (torahPortion && (
              torahPortion.includes("סוכות") ||
              torahPortion.includes("סוכה") ||
              torahPortion.includes("חג הסוכות") ||
              torahPortion.includes("חול המועד סוכות")
            )) || window.location.search.includes("sukot");
            
            const isSimhatTora = (torahPortion && torahPortion.includes("שמחת תורה")) ||
                               window.location.search.includes("simhat_tora");
            
            // בדיקה לחול המועד
            const isCholHamoed = (torahPortion && (
              torahPortion.includes("חול המועד") ||
              torahPortion.includes("חול המועד סוכות") ||
              torahPortion.includes("חול המועד פסח")
            ));
            
            // Debug info
            console.log('Torah portion text:', torahPortion);
            console.log('isCholHamoed:', isCholHamoed);
            console.log('isSukot:', isSukot);
      
      if (isRoshHashana) {
        statusContainer.style.backgroundImage = "url('rosh-hashna.jpg')";
        statusContainer.style.backgroundSize = "cover";
        statusContainer.style.backgroundPosition = "center";
        statusContainer.style.backgroundRepeat = "no-repeat";
            } else if (isYomKippur) {
              statusContainer.style.backgroundImage = "url('yom-kippur.jpeg')";
              statusContainer.style.backgroundSize = "cover";
              statusContainer.style.backgroundPosition = "center";
              statusContainer.style.backgroundRepeat = "no-repeat";
            } else if (isSukot) {
              statusContainer.style.backgroundImage = "url('sukot.jpeg')";
        statusContainer.style.backgroundSize = "cover";
        statusContainer.style.backgroundPosition = "center";
        statusContainer.style.backgroundRepeat = "no-repeat";
            } else if (isSimhatTora) {
              statusContainer.style.backgroundImage = "url('simhat-tora.jpeg')";
              statusContainer.style.backgroundSize = "cover";
              statusContainer.style.backgroundPosition = "center";
              statusContainer.style.backgroundRepeat = "no-repeat";
            } else if (isCholHamoed) {
              // חול המועד - נקבע לפי איזה חג
              // אם זה חול המועד ולא מצוין איזה חג, נבדוק לפי התאריך
              const currentDate = new Date();
              const month = currentDate.getMonth() + 1; // 1-12
              const day = currentDate.getDate();
              
              // סוכות בדרך כלל באוקטובר (חודש 10)
              if (month === 10 || (month === 9 && day >= 15)) {
                statusContainer.style.backgroundImage = "url('sukot.jpeg')";
              } else if (month === 4) { // פסח בדרך כלל באפריל
                statusContainer.style.backgroundImage = "url('sukot.jpeg')"; // נשתמש באותה תמונה עד שתמצא תמונת פסח
              } else {
                // ברירת מחדל לסוכות אם לא בטוחים
                statusContainer.style.backgroundImage = "url('sukot.jpeg')";
              }
              statusContainer.style.backgroundSize = "cover";
              statusContainer.style.backgroundPosition = "center";
              statusContainer.style.backgroundRepeat = "no-repeat";
        
        const shabbatTable = document.querySelector('.shabbat-table');
        if (shabbatTable) {
          shabbatTable.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
          shabbatTable.style.borderRadius = '10px';
          shabbatTable.style.overflow = 'hidden';
          shabbatTable.style.marginBottom = '20px';
        }
        
        const title = document.querySelector('.title');
        if (title) {
          title.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
          title.style.borderRadius = '10px';
          title.style.padding = '10px';
        }
        
        const footer = document.querySelector('.footer-text');
        if (footer) {
          footer.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
          footer.style.borderRadius = '10px';
          footer.style.padding = '10px';
          footer.style.marginTop = '10px';
        }
        
        let personImg = document.getElementById('person-overlay');
        if (!personImg) {
          personImg = document.createElement('img');
          personImg.id = 'person-overlay';
          personImg.src = 'ori_clean.png';
                
                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;
                const isDesktop = window.innerWidth >= 1200;
                const isLargeDesktop = window.innerWidth >= 1600;
                
                if (isSmallMobile) {
          personImg.style.cssText = `
            position: absolute;
                    top: 50px;
                    left: 8%;
                    transform: translateX(-20%);
                    width: 200px;
                    height: auto;
                    z-index: 10;
                  `;
                } else if (isMobile) {
                  personImg.style.cssText = `
                    position: absolute;
                    top: 50px;
                    left: 8%;
                    transform: translateX(-20%);
                    width: 220px;
                    height: auto;
                    z-index: 10;
                  `;
                } else if (isLargeDesktop) {
                  personImg.style.cssText = `
                    position: absolute;
                    top: 170px;
                    left: 20%;
                    transform: translateX(-20%);
                    width: 250px;
                    height: auto;
                    z-index: 10;
                  `;
                } else if (isDesktop) {
                  personImg.style.cssText = `
                    position: absolute;
                    top: 180px;
                    left: 25%;
                    transform: translateX(-20%);
                    width: 220px;
                    height: auto;
                    z-index: 10;
                  `;
                } else {
                  personImg.style.cssText = `
                    position: absolute;
                    top: 40px;
            left: 31%;
            transform: translateX(-20%);
            width: 195px;
            height: auto;
            z-index: 10;
          `;
                }
                
          statusContainer.appendChild(personImg);
        }
        personImg.style.display = 'block';
      } else {
        statusContainer.style.backgroundImage = "url('shabat.webp')";
        statusContainer.style.backgroundSize = "cover";
        statusContainer.style.backgroundPosition = "center";
        statusContainer.style.backgroundRepeat = "no-repeat";
        
        const shabbatTable = document.querySelector('.shabbat-table');
        if (shabbatTable) {
          shabbatTable.style.backgroundColor = '';
          shabbatTable.style.borderRadius = '';
          shabbatTable.style.overflow = '';
          shabbatTable.style.marginBottom = '';
        }
        
        const title = document.querySelector('.title');
        if (title) {
          title.style.backgroundColor = '';
          title.style.borderRadius = '';
          title.style.padding = '';
        }
        
        const footer = document.querySelector('.footer-text');
        if (footer) {
          footer.style.backgroundColor = '';
          footer.style.borderRadius = '';
          footer.style.padding = '';
          footer.style.marginTop = '';
        }
        
        const personImg = document.getElementById('person-overlay');
        if (personImg) {
          personImg.style.display = 'none';
        }
      }
    }

    cities.forEach((city) => {
      const cityData = closestEvents.find(event => event.city === city.name);
      
      if (cityData) {
        document.getElementById(`${city.id}-shabbat-enter`).textContent =
          cityData.candleLighting && cityData.candleLighting !== "לא זמין" ? cityData.candleLighting : "לא זמין";
        document.getElementById(`${city.id}-shabbat-exit`).textContent =
          cityData.shabbatExit && cityData.shabbatExit !== "לא זמין" ? cityData.shabbatExit : "לא זמין";
        document.getElementById(`${city.id}-rabenu-tam`).textContent =
          cityData.rabenuTam && cityData.rabenuTam !== "לא זמין" ? cityData.rabenuTam : "לא זמין";
      } else {
        document.getElementById(`${city.id}-shabbat-enter`).textContent = "לא זמין";
        document.getElementById(`${city.id}-shabbat-exit`).textContent = "לא זמין";
        document.getElementById(`${city.id}-rabenu-tam`).textContent = "לא זמין";
      }
    });
  } catch (error) {
          console.error('Error loading shabbat times:', error);
        }
      }

      async function downloadImage() {
        // בדיקה אם html2canvas נטען
        if (typeof html2canvas === 'undefined') {
          console.error('שגיאה: ספריית html2canvas לא נטענה. אנא רענן את הדף ונסה שוב.');
          return;
        }
        
        const statusElement = document.getElementById("status");
        
        setTimeout(async () => {
          try {
            const canvas = await html2canvas(statusElement, {
              scale: 2,
            width: statusElement.offsetWidth,
            height: statusElement.offsetHeight,
              backgroundColor: null,
            onclone: (clonedDocument) => {
              const container = clonedDocument.querySelector(".status-container");
                container.style.backgroundSize = "cover";
              container.style.backgroundPosition = "center";
              container.style.backgroundRepeat = "no-repeat";
              
              const personImg = clonedDocument.getElementById('person-overlay');
              if (personImg) {
                personImg.style.display = 'block';
                  
                  const isMobile = window.innerWidth <= 768;
                  const isSmallMobile = window.innerWidth <= 480;
                  const isDesktop = window.innerWidth >= 1200;
                  const isLargeDesktop = window.innerWidth >= 1600;
                  
                  if (isSmallMobile) {
                    personImg.style.top = '200px';
                    personImg.style.left = '12%';
                    personImg.style.width = '200px';
                  } else if (isMobile) {
                    personImg.style.top = '200px';
                    personImg.style.left = '10%';
                    personImg.style.width = '220px';
                  } else if (isLargeDesktop) {
                    personImg.style.top = '170px';
                    personImg.style.left = '20%';
                    personImg.style.width = '250px';
                  } else if (isDesktop) {
                    personImg.style.top = '180px';
                    personImg.style.left = '25%';
                    personImg.style.width = '220px';
                  } else {
                    personImg.style.top = '190px';
                    personImg.style.left = '31%';
                    personImg.style.width = '195px';
                  }
                }
                
              const headerInfo = clonedDocument.querySelector('.header-info');
              if (headerInfo) {
                headerInfo.style.position = 'relative';
                headerInfo.style.transform = 'none';
                headerInfo.style.top = '0px';
                headerInfo.style.left = '0px';
                headerInfo.style.marginTop = '0px';
                headerInfo.style.marginBottom = '15px';
                headerInfo.style.zIndex = '5';
              }
              
              const arcText = clonedDocument.querySelector('.arc-text');
              if (arcText) {
                  arcText.style.position = 'absolute';
                  arcText.style.top = '150px';
                  arcText.style.left = '50%';
                  arcText.style.transform = 'translateX(-50%)';
                arcText.style.zIndex = '15';
                  arcText.style.pointerEvents = 'none';
                  
                  const svg = arcText.querySelector('svg');
                  if (svg) {
                    svg.setAttribute('viewBox', '0 0 300 120');
                    svg.style.width = '300px';
                    svg.style.height = '120px';
                  }
                  
                  const shabbatTable = clonedDocument.querySelector('.shabbat-table');
                  if (shabbatTable) {
                    shabbatTable.style.marginTop = '330px';
                  }
                  
                  const footer = clonedDocument.querySelector('.footer-text');
                  if (footer) {
                    footer.style.marginTop = '0px';
                    footer.style.marginBottom = '10px';
                  }
                }
                
                const clonedTableHeaders = clonedDocument.querySelectorAll('.shabbat-table th');
                if (clonedTableHeaders.length >= 3) {
                  const torahPortion = document.getElementById('torah-portion')?.textContent || '';
                  const isHoliday = torahPortion && (
                    torahPortion.includes("ראש השנה") || 
                    torahPortion.includes("יום כיפור") || 
                    torahPortion.includes("סוכות") || 
                    torahPortion.includes("פסח") || 
                    torahPortion.includes("שבועות") ||
                    torahPortion.includes("שמחת תורה") ||
                    torahPortion.includes("חג")
                  );
                  
                  if (isHoliday) {
                    clonedTableHeaders[1].textContent = "כניסת החג";
                    clonedTableHeaders[2].textContent = "יציאת החג";
                  } else {
                    clonedTableHeaders[1].textContent = "כניסת שבת";
                    clonedTableHeaders[2].textContent = "יציאת שבת";
                  }
                }
              },
            });
            
            // המרת canvas ל-blob
            canvas.toBlob(async (blob) => {
              if (!blob) {
                console.error('שגיאה ביצירת התמונה');
                return;
              }
              
              // בדיקה אם יש תמיכה ב-Web Share API
              if (navigator.share && navigator.canShare) {
                try {
                  const file = new File([blob], 'shabbat-status.png', { type: 'image/png' });
                  const shareData = {
                    files: [file],
                    title: 'זמני שבת',
                    text: ''
                  };
                  
                  // בדיקה אם אפשר לשתף קבצים
                  if (navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    return;
                  }
                } catch (error) {
                  // אם השיתוף נכשל או בוטל, ממשיכים להורדה רגילה
                  console.log('Share cancelled or failed:', error);
                }
              }
              
              // אם אין תמיכה בשיתוף או שהשיתוף נכשל - הורדה רגילה
              const dataURL = canvas.toDataURL("image/png");
              const link = document.createElement("a");
              link.href = dataURL;
              link.download = "shabbat-status.png";
              link.style.display = "none";
              document.body.appendChild(link);
                link.click();
              document.body.removeChild(link);
            }, 'image/png');
                
          } catch (error) {
            console.error('Error creating canvas:', error);
            console.error('שגיאה ביצירת התמונה: ' + error.message);
          }
              }, 1000);
      }

      function loadPreviousEvent() {
        const sortedDates = Object.keys(eventsByDate).sort();
        currentEventIndex = currentEventIndex > 0 ? currentEventIndex - 1 : sortedDates.length - 1;
        loadShabbatTimes().then(() => {
          updateBackground();
        }).catch(error => {
          console.error('Error loading previous event:', error);
        });
      }

      function loadNextEvent() {
        const sortedDates = Object.keys(eventsByDate).sort();
        currentEventIndex = (currentEventIndex + 1) % sortedDates.length;
        loadShabbatTimes().then(() => {
          updateBackground();
        }).catch(error => {
          console.error('Error loading next event:', error);
        });
      }

      function updateBackground() {
        const torahPortionElement = document.getElementById("torah-portion");
        const torahPortion = torahPortionElement ? torahPortionElement.textContent : "";
        
        const statusContainer = document.querySelector('.status-container');
        
        if (statusContainer) {
          const isRoshHashana = (torahPortion && torahPortion.includes("ראש השנה")) || 
                               window.location.search.includes("rosh_hashana");
          
          const isYomKippur = (torahPortion && torahPortion.includes("יום כיפור")) ||
                             window.location.search.includes("yom_kippur");
          
          const isSukot = (torahPortion && (
            torahPortion.includes("סוכות") ||
            torahPortion.includes("סוכה") ||
            torahPortion.includes("חג הסוכות") ||
            torahPortion.includes("חול המועד סוכות")
          )) || window.location.search.includes("sukot");
          
          const isSimhatTora = (torahPortion && torahPortion.includes("שמחת תורה")) ||
                             window.location.search.includes("simhat_tora");
          
          // בדיקה לחול המועד
          const isCholHamoed = (torahPortion && (
            torahPortion.includes("חול המועד") ||
            torahPortion.includes("חול המועד סוכות") ||
            torahPortion.includes("חול המועד פסח")
          ));
          
          if (isRoshHashana) {
            statusContainer.style.backgroundImage = "url('rosh-hashna1.jpeg')";
            statusContainer.style.backgroundSize = "cover";
            statusContainer.style.backgroundPosition = "center";
            statusContainer.style.backgroundRepeat = "no-repeat";
          } else if (isYomKippur) {
            statusContainer.style.backgroundImage = "url('yom-kippur.jpeg')";
            statusContainer.style.backgroundSize = "cover";
            statusContainer.style.backgroundPosition = "center";
            statusContainer.style.backgroundRepeat = "no-repeat";
          } else if (isSukot) {
            statusContainer.style.backgroundImage = "url('sukot.jpeg')";
            statusContainer.style.backgroundSize = "cover";
            statusContainer.style.backgroundPosition = "center";
            statusContainer.style.backgroundRepeat = "no-repeat";
          } else if (isSimhatTora) {
            statusContainer.style.backgroundImage = "url('simhat-tora.jpeg')";
            statusContainer.style.backgroundSize = "cover";
            statusContainer.style.backgroundPosition = "center";
            statusContainer.style.backgroundRepeat = "no-repeat";
          } else if (isCholHamoed) {
            // חול המועד - נקבע לפי איזה חג
            // אם זה חול המועד ולא מצוין איזה חג, נבדוק לפי התאריך
            const currentDate = new Date();
            const month = currentDate.getMonth() + 1; // 1-12
            const day = currentDate.getDate();
            
            // סוכות בדרך כלל באוקטובר (חודש 10)
            if (month === 10 || (month === 9 && day >= 15)) {
              statusContainer.style.backgroundImage = "url('sukot.jpeg')";
            } else if (month === 4) { // פסח בדרך כלל באפריל
              statusContainer.style.backgroundImage = "url('sukot.jpeg')"; // נשתמש באותה תמונה עד שתמצא תמונת פסח
            } else {
              // ברירת מחדל לסוכות אם לא בטוחים
              statusContainer.style.backgroundImage = "url('sukot.jpeg')";
            }
            statusContainer.style.backgroundSize = "cover";
            statusContainer.style.backgroundPosition = "center";
            statusContainer.style.backgroundRepeat = "no-repeat";
            
            const shabbatTable = document.querySelector('.shabbat-table');
            if (shabbatTable) {
              shabbatTable.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
              shabbatTable.style.borderRadius = '10px';
              shabbatTable.style.overflow = 'hidden';
              shabbatTable.style.marginBottom = '20px';
            }
            
            const title = document.querySelector('.title');
            if (title) {
              title.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
              title.style.borderRadius = '10px';
              title.style.padding = '10px';
            }
            
            const footer = document.querySelector('.footer-text');
            if (footer) {
              footer.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
              footer.style.borderRadius = '10px';
              footer.style.padding = '10px';
              footer.style.marginTop = '10px';
            }
            
            let personImg = document.getElementById('person-overlay');
            if (!personImg) {
              personImg = document.createElement('img');
              personImg.id = 'person-overlay';
              personImg.src = 'ori_clean.png';
              
              const isMobile = window.innerWidth <= 768;
              const isSmallMobile = window.innerWidth <= 480;
              
              if (isSmallMobile) {
              personImg.style.cssText = `
                position: absolute;
                  top: 220px;
                  left: 8%;
                transform: translateX(-20%);
                  width: 200px;
                  height: auto;
                z-index: 10;
                pointer-events: none;
              `;
              } else if (isMobile) {
                personImg.style.cssText = `
                  position: absolute;
                  top: 200px;
                  left: 10%;
                  transform: translateX(-20%);
                  width: 220px;
                  height: auto;
                  z-index: 10;
                  pointer-events: none;
                `;
              } else {
                personImg.style.cssText = `
                  position: absolute;
                  top: 210px;
                  left: 31%;
                  transform: translateX(-20%);
                  width: 195px;
                  height: auto;
                  z-index: 10;
                  pointer-events: none;
                `;
              }
              
              statusContainer.appendChild(personImg);
            }
            personImg.style.display = 'block';
          } else {
            statusContainer.style.backgroundImage = "url('shabat.webp')";
            statusContainer.style.backgroundSize = "cover";
            statusContainer.style.backgroundPosition = "center";
            statusContainer.style.backgroundRepeat = "no-repeat";
            
            const shabbatTable = document.querySelector('.shabbat-table');
            if (shabbatTable) {
              shabbatTable.style.backgroundColor = '';
              shabbatTable.style.borderRadius = '';
              shabbatTable.style.overflow = '';
              shabbatTable.style.marginBottom = '';
            }
            
            const title = document.querySelector('.title');
            if (title) {
              title.style.backgroundColor = '';
              title.style.borderRadius = '';
              title.style.padding = '';
            }
            
            const footer = document.querySelector('.footer-text');
            if (footer) {
              footer.style.backgroundColor = '';
              footer.style.borderRadius = '';
              footer.style.padding = '';
              footer.style.marginTop = '';
            }
            
            let personImg = document.getElementById('person-overlay');
            if (!personImg) {
              personImg = document.createElement('img');
              personImg.id = 'person-overlay';
              personImg.src = 'ori_clean.png';
              
              const isMobile = window.innerWidth <= 768;
              const isSmallMobile = window.innerWidth <= 480;
              
              if (isSmallMobile) {
              personImg.style.cssText = `
                position: absolute;
                  top: 220px;
                  left: 8%;
                transform: translateX(-20%);
                  width: 200px;
                  height: auto;
                z-index: 10;
                pointer-events: none;
              `;
              } else if (isMobile) {
                personImg.style.cssText = `
                  position: absolute;
                  top: 200px;
                  left: 10%;
                  transform: translateX(-20%);
                  width: 220px;
                  height: auto;
                  z-index: 10;
                  pointer-events: none;
                `;
              } else {
                personImg.style.cssText = `
                  position: absolute;
                  top: 210px;
                  left: 31%;
                  transform: translateX(-20%);
                  width: 195px;
                  height: auto;
                  z-index: 10;
                  pointer-events: none;
                `;
              }
              
              statusContainer.appendChild(personImg);
            }
            personImg.style.display = 'block';
          }
        }
      }

      loadShabbatTimes().catch(error => {
        console.error('Error loading shabbat times:', error);
      });
      
      window.addEventListener('resize', function() {
        const personImg = document.getElementById('person-overlay');
        if (personImg) {
          const isMobile = window.innerWidth <= 768;
          const isSmallMobile = window.innerWidth <= 480;
          const isDesktop = window.innerWidth >= 1200;
          const isLargeDesktop = window.innerWidth >= 1600;
          
          if (isSmallMobile) {
            personImg.style.top = '50px';
            personImg.style.left = '8%';
            personImg.style.width = '200px';
          } else if (isMobile) {
            personImg.style.top = '50px';
            personImg.style.left = '8%';
            personImg.style.width = '220px';
          } else if (isLargeDesktop) {
            personImg.style.top = '170px';
            personImg.style.left = '20%';
            personImg.style.width = '250px';
          } else if (isDesktop) {
            personImg.style.top = '180px';
            personImg.style.left = '25%';
            personImg.style.width = '220px';
          } else {
            personImg.style.top = '40px';
            personImg.style.left = '31%';
            personImg.style.width = '195px';
          }
        }
      });

    </script>
  </body>
</html>